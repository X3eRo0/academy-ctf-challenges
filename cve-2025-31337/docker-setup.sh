#!/bin/bash

# CTF FTP Server Docker Setup Script

set -e

echo "🐳 Setting up CTF FTP Server in Docker..."

# Create necessary directories
echo "📁 Creating directories..."
mkdir -p ftp_data
mkdir -p ftp_data/anonymous
mkdir -p ftp_data/user1
mkdir -p ftp_data/user2

# Create some test files
echo "📄 Creating test files..."
echo "Welcome to anonymous FTP!" > ftp_data/anonymous/readme.txt
echo "This is a test file for user1" > ftp_data/user1/test.txt
echo "Another test file for user2" > ftp_data/user2/data.txt
echo "Secret flag: FAUST_{docker_ftp_server_works}" > ftp_data/anonymous/flag.txt

# Build and start the server
echo "🔨 Building Docker image..."
docker-compose build

echo "🚀 Starting FTP server..."
docker-compose up -d ftp-server

# Wait for server to start
echo "⏳ Waiting for server to start..."
sleep 3

# Check if server is running
if docker-compose ps | grep -q "ftp-server.*Up"; then
    echo "✅ FTP Server is running!"
    echo ""
    echo "📋 Server Information:"
    echo "   Host: localhost"
    echo "   Port: 2121"
    echo "   Anonymous access: enabled"
    echo ""
    echo "👥 Test Users Created:"
    echo "   Username: testuser, Password: testpass"
    echo "   Username: admin, Password: admin123"
    echo ""
    echo "🧪 Test Commands:"
    echo "   # Test anonymous login:"
    echo "   python3 test_client.py anonymous"
    echo ""
    echo "   # Test user registration:"
    echo "   python3 test_client.py register newuser newpass"
    echo ""
    echo "   # Test existing user login:"
    echo "   python3 test_client.py login testuser testpass"
    echo ""
    echo "   # List files:"
    echo "   python3 test_client.py list"
    echo ""
    echo "   # Test vulnerabilities:"
    echo "   python3 test_client.py test_vuln list"
    echo "   python3 test_client.py test_vuln put"
    echo "   python3 test_client.py test_vuln search"
    echo ""
    echo "🔧 Management Commands:"
    echo "   # View logs:"
    echo "   docker-compose logs -f ftp-server"
    echo ""
    echo "   # Stop server:"
    echo "   docker-compose down"
    echo ""
    echo "   # Restart server:"
    echo "   docker-compose restart ftp-server"
    echo ""
    echo "   # Connect to server container:"
    echo "   docker-compose exec ftp-server /bin/bash"
else
    echo "❌ Failed to start FTP server"
    echo "📋 Checking logs..."
    docker-compose logs ftp-server
    exit 1
fi
