# CTF FTP Server

A custom binary protocol FTP server designed for attack and defense CTF competitions. Contains three intentional memory corruption vulnerabilities of varying difficulty levels.

## Features

- **Custom Binary Protocol**: Non-standard binary protocol instead of plaintext FTP
- **User Authentication**: Database-backed user authentication with SHA256+salt password hashing
- **Anonymous Access**: Support for anonymous FTP access
- **Chroot Sandboxing**: Per-user directory isolation using chroot
- **Fork Server**: Each client connection handled by a separate process
- **Memory Corruption Vulnerabilities**: Three carefully crafted bugs for CTF exploitation

## Vulnerabilities

### Easy: Buffer Overflow in LIST Command
- **Location**: `commands.c:handle_list()`
- **Type**: Stack-based buffer overflow
- **Trigger**: Send LIST command with long directory path (>256 chars)
- **Impact**: Stack corruption, potential RCE

### Medium: Heap Overflow in PUT Command  
- **Location**: `commands.c:handle_put()`
- **Type**: Heap-based buffer overflow
- **Trigger**: Declare small file size but send much more data
- **Impact**: Heap corruption, potential RCE

### Hard: Integer Overflow in SEARCH Command
- **Location**: `commands.c:handle_search()`
- **Type**: Integer overflow leading to heap corruption
- **Trigger**: Send SEARCH with pattern_len = 0xFFFFFFFF
- **Impact**: Massive heap corruption when pattern_len + 1 wraps to 0

## Building

### Prerequisites
```bash
# Ubuntu/Debian
sudo apt-get install build-essential libsqlite3-dev libssl-dev

# macOS
brew install sqlite openssl

# CentOS/RHEL
sudo yum install gcc sqlite-devel openssl-devel
```

### Compilation
```bash
make all          # Build server and user admin utility
make setup        # Create directory structure and test files
make test         # Create test users and database
```

### Build Variants
```bash
make debug        # Build with debug symbols and AddressSanitizer
make vulnerable   # Build with all protections disabled for easier exploitation
```

## Usage

### 1. Setup Environment
```bash
make setup        # Create ftp_root directory structure
make test         # Create test database and users
```

### 2. Start Server
```bash
sudo ./ftp_server 2121 ftp_users.db ftp_root
```
**Note**: `sudo` required for chroot functionality

### 3. Create Users
```bash
./user_admin create_user alice secret123 user_alice
./user_admin create_user bob password456 user_bob
```

### 4. Test Connection
```bash
# Test with Python client
python3 test_client.py anonymous
python3 test_client.py login alice secret123
python3 test_client.py list
python3 test_client.py get readme.txt

# Test vulnerabilities
python3 test_client.py test_vuln list    # Easy bug
python3 test_client.py test_vuln put     # Medium bug  
python3 test_client.py test_vuln search  # Hard bug
```

## Protocol Specification

### Packet Structure
```
+----------------+------------------+------------------+
| Magic (4 bytes) | Type (1 byte)   | Length (2 bytes) |
+----------------+------------------+------------------+
| Payload (variable length)                           |
+-----------------------------------------------------+
```

- **Magic**: `0x46545021` ("FTP!")
- **Type**: Command/Response type code
- **Length**: Payload length in network byte order

### Commands
- `0x01` - LOGIN (username/password authentication)
- `0x02` - ANONYMOUS (anonymous login)
- `0x10` - GET (download file)
- `0x11` - PUT (upload file) 
- `0x12` - LIST (list directory)
- `0x13` - MKDIR (create directory)
- `0x14` - DELETE (delete file)
- `0x15` - RENAME (rename file)
- `0x16` - STAT (file statistics)
- `0x17` - SEARCH (search files - vulnerable)

### Responses
- `0x80` - AUTH_RESPONSE
- `0x90` - FILE_DATA
- `0x91` - FILE_LIST
- `0x92` - STAT_INFO
- `0x93` - SEARCH_RESULTS
- `0x9F` - GENERIC_RESPONSE

## Directory Structure
```
ftp_root/
├── anonymous/          # Anonymous user sandbox
│   └── readme.txt
├── user1/             # User home directories
│   └── test.txt
└── user2/
    └── data.txt
```

## Security Notes

⚠️ **FOR CTF USE ONLY**: This server contains intentional vulnerabilities and should never be used in production environments.

- Run in isolated environments only
- Use non-privileged ports when possible
- Monitor for crashes and restart as needed
- Consider using containers for additional isolation

## Exploitation Tips

1. **Easy Bug**: Craft LIST payload with path > 256 bytes
2. **Medium Bug**: Use PUT with small declared size but large actual data
3. **Hard Bug**: Trigger integer overflow with SEARCH pattern_len = 0xFFFFFFFF

## Files

- `ftp_server.h` - Protocol definitions and structures
- `server.c` - Main server and fork handling
- `protocol.c` - Packet send/receive functions
- `commands.c` - Command handlers (contains vulnerabilities)
- `database.c` - User authentication and database
- `user_admin.c` - User management utility
- `test_client.py` - Python test client with exploit demos
- `Makefile` - Build configuration
- `README.md` - This file
- `protocol.md` - Detailed protocol specification

## License

This project is for educational and CTF purposes only.
