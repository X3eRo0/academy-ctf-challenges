# CTF FTP Server - Docker Deployment

🐳 Complete Docker setup for the CTF FTP Server with memory corruption vulnerabilities.

## Quick Start

```bash
# Setup and start the server
./docker-setup.sh

# Test basic functionality
python3 test_client.py anonymous
python3 test_client.py list

# Test user registration
python3 test_client.py register newuser newpass

# Test vulnerabilities
python3 exploit.py
```

## What's Included

### 🎯 Core Components
- **FTP Server** (`ftp_server`) - Main binary protocol server
- **User Admin** (`user_admin`) - User management utility  
- **Test Client** (`test_client.py`) - Python client for testing
- **Exploit Script** (`exploit.py`) - Demonstration of all vulnerabilities

### 🐋 Docker Components
- **Dockerfile** - Multi-stage x86_64 Linux build
- **docker-compose.yml** - Service orchestration
- **docker-setup.sh** - Automated setup script

### 🔐 Vulnerabilities
1. **EASY**: Buffer overflow in LIST command (Stack-based)
2. **MEDIUM**: Heap overflow in PUT command (Size validation bypass)
3. **HARD**: Integer overflow in SEARCH command (Heap corruption)

## System Requirements

- Docker & Docker Compose
- Python 3.6+ (for testing scripts)
- x86_64 architecture (Linux containers)

## Directory Structure

```
📁 Project Root
├── 🐳 Docker Files
│   ├── Dockerfile              # Container build configuration
│   ├── docker-compose.yml      # Service definitions
│   └── docker-setup.sh         # Automated setup script
├── 💻 Server Code
│   ├── ftp_server.h            # Protocol definitions
│   ├── server.c                # Main server + fork handling
│   ├── protocol.c              # Network protocol implementation
│   ├── commands.c              # FTP commands (with vulnerabilities)
│   ├── database.c              # User authentication & SQLite
│   └── user_admin.c            # User management utility
├── 🔧 Build System
│   ├── Makefile                # Cross-platform build
│   └── protocol.md             # Binary protocol specification
├── 🧪 Testing & Exploitation
│   ├── test_client.py          # Functional testing client
│   ├── exploit.py              # Vulnerability demonstration
│   └── checker.py              # FAUST CTF gameserver checker
└── 📚 Documentation
    ├── README.md               # Main documentation
    ├── DOCKER_README.md        # This file
    └── CHECKER_DEPLOYMENT.md   # CTF checker deployment
```

## Configuration

### Environment Variables
- `FTP_PORT` - Server port (default: 2121)
- `DB_PATH` - Database file path (default: ftp_users.db)
- `ROOT_DIR` - FTP root directory (default: ftp_root)

### Volume Mounts
- `./ftp_data:/app/ftp_root` - FTP file storage
- `./ftp_users.db:/app/ftp_users.db` - User database

## Usage Examples

### Basic Server Operations

```bash
# Start server
docker-compose up -d ftp-server

# View logs
docker-compose logs -f ftp-server

# Stop server
docker-compose down

# Restart server
docker-compose restart ftp-server
```

### Client Testing

```bash
# Anonymous login and file listing
python3 test_client.py anonymous
python3 test_client.py list

# User registration (creates temp directory)
python3 test_client.py register alice secretpass

# Existing user login
python3 test_client.py login testuser testpass

# File operations
python3 test_client.py get readme.txt
```

### Vulnerability Testing

```bash
# Individual vulnerability tests
python3 test_client.py test_vuln list      # Buffer overflow
python3 test_client.py test_vuln put       # Heap overflow  
python3 test_client.py test_vuln search    # Integer overflow

# Comprehensive exploitation demo
python3 exploit.py                         # All vulnerabilities
python3 exploit.py <target_ip>             # Remote target
```

### Container Management

```bash
# Execute commands in container
docker-compose exec ftp-server /bin/bash

# Create additional users
docker-compose exec ftp-server ./user_admin create_user bob password123 bob_home

# View container processes
docker-compose exec ftp-server ps aux

# Check disk usage
docker-compose exec ftp-server df -h
```

## Vulnerability Details

### 🟢 EASY: LIST Buffer Overflow
```c
char path[256];  // Fixed size buffer
// No bounds checking on path copy
memcpy(path, user_input, user_input_length);  // VULNERABLE
```
**Exploitation**: Send LIST command with path > 256 bytes

### 🟡 MEDIUM: PUT Heap Overflow  
```c
char *buffer = malloc(declared_size);        // Allocate based on declared size
memcpy(buffer, actual_data, actual_length);  // Copy actual data - VULNERABLE
```
**Exploitation**: Declare small size, send large data

### 🔴 HARD: SEARCH Integer Overflow
```c
size_t buffer_size = pattern_len + 1;        // Integer overflow when pattern_len = 0xFFFFFFFF
char *buffer = malloc(buffer_size);          // Allocates tiny buffer (0 bytes)
memcpy(buffer, pattern, pattern_len);        // Massive heap corruption - VULNERABLE
```
**Exploitation**: Send pattern_len = 0xFFFFFFFF

## Development

### Building Locally
```bash
# Build without Docker
make all

# Setup test environment  
make setup
make test

# Build with debug symbols
make debug

# Build without protections (for easier exploitation)
make vulnerable
```

### Debugging
```bash
# Run with GDB
docker-compose exec ftp-server gdb ./ftp_server

# Check for memory leaks
docker-compose exec ftp-server valgrind ./ftp_server 2121 ftp_users.db ftp_root

# Core dump analysis
docker-compose exec ftp-server gdb ./ftp_server core
```

## Security Considerations

⚠️ **WARNING: This software contains intentional vulnerabilities**

- **For CTF/Educational Use Only**
- **Never deploy in production environments**
- **Run in isolated containers/VMs**
- **Monitor for crashes and resource usage**

### Recommended CTF Deployment
1. Use isolated Docker networks
2. Implement automatic service restart
3. Monitor and log all connections
4. Provide controlled access to flags
5. Set resource limits on containers

## Troubleshooting

### Common Issues

**Server won't start**
```bash
# Check logs
docker-compose logs ftp-server

# Verify port availability
netstat -tulpn | grep 2121

# Check container status
docker-compose ps
```

**Build failures**
```bash
# Clean rebuild
docker-compose down
docker-compose build --no-cache

# Check dependencies
docker-compose exec ftp-server pkg-config --cflags --libs openssl sqlite3
```

**Connection refused**
```bash
# Verify server is listening
docker-compose exec ftp-server netstat -tulpn | grep 2121

# Test with telnet
telnet localhost 2121

# Check firewall rules
iptables -L
```

### Performance Tuning

```bash
# Increase connection limits
echo 'net.core.somaxconn = 1024' >> /etc/sysctl.conf

# Monitor resource usage
docker stats

# Limit container resources
docker-compose exec ftp-server systemd-cgtop
```

## Contributing

1. Fork the repository
2. Create feature branch
3. Add tests for new functionality
4. Ensure Docker build works
5. Submit pull request

## License

Educational/CTF use only. Not for production deployment.

---

🎯 **Happy Hacking!** 🎓
