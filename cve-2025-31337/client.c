#include "client.h"

void handle_client(int client_fd)
{
    printf("Handling client on fd %d\n", client_fd);

    // Send hello world message
    const char* hello_msg = "220 Hello World! Welcome to CTF FTP Server\r\n";

    if (send(client_fd, hello_msg, strlen(hello_msg), 0) == -1) {
        perror("send");
        return;
    }

    printf("Sent hello world to client\n");

    // For now, just close the connection after sending hello
    // Later you can add a command loop here

    printf("Client handler finished\n");
}

void send_response(int fd, const char* code, const char* message)
{
    char response[BUFFER_SIZE];
    snprintf(response, sizeof(response), "%s %s\r\n", code, message);

    if (send(fd, response, strlen(response), 0) == -1) {
        perror("send_response");
    }
}

int parse_command(const char* buffer, char* command, char* args)
{
    // Clear the output buffers
    command[0] = '\0';
    args[0] = '\0';

    // Skip leading whitespace
    while (*buffer == ' ' || *buffer == '\t') {
        buffer++;
    }

    // Extract command (until space or end of string)
    int i = 0;
    while (*buffer && *buffer != ' ' && *buffer != '\t' && *buffer != '\r' && *buffer != '\n') {
        if (i < 63) { // Prevent buffer overflow
            command[i++] = *buffer;
        }
        buffer++;
    }
    command[i] = '\0';

    // Skip whitespace after command
    while (*buffer == ' ' || *buffer == '\t') {
        buffer++;
    }

    // Extract arguments (rest of the line, minus \r\n)
    i = 0;
    while (*buffer && *buffer != '\r' && *buffer != '\n') {
        if (i < 255) { // Prevent buffer overflow
            args[i++] = *buffer;
        }
        buffer++;
    }
    args[i] = '\0';

    return strlen(command) > 0 ? 1 : 0;
}

void cleanup_client(client_state_t* client)
{
    if (client->data_fd > 0) {
        close(client->data_fd);
        client->data_fd = -1;
    }

    printf("Client cleanup completed\n");
}
