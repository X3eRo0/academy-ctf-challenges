# CTF FTP Server Checker Deployment Guide

This guide explains how to deploy the checker script for the CTF FTP Server in a FAUST CTF gameserver environment.

## Files Overview

### Core Checker Files
- `checker.py` - Main checker script implementing FAUST CTF checkerlib interface
- `checker_setup.py` - Optional setup script for service initialization
- `CHECKER_DEPLOYMENT.md` - This deployment guide

### Required Dependencies
- Python 3.8+ with `ctf_gameserver.checkerlib` package
- Network access to FTP service on port 2121

## Installation

### 1. Install CTF Gameserver
```bash
# Clone the repository
git clone https://github.com/fausecteam/ctf-gameserver.git
cd ctf-gameserver

# Install the package
pip install .
```

### 2. Deploy Checker
```bash
# Copy checker to gameserver
cp checker.py /path/to/checkers/ftp_checker.py
chmod +x /path/to/checkers/ftp_checker.py
```

### 3. Configure Gameserver
Add to your gameserver configuration:

```yaml
# config.yml
services:
  ftp:
    name: "FTP Server"
    checker: "/path/to/checkers/ftp_checker.py"
    port: 2121
    timeout: 30
```

## Checker Functionality

### Place Flag (`place_flag`)
1. **Authentication**: Connects as anonymous user
2. **Flag Storage**: Creates unique filename with random suffix
3. **Directory Structure**: Creates per-tick directories for organization
4. **Flag ID**: Stores filename and metadata as JSON in flag ID
5. **Verification**: Uploads flag content and verifies success

### Check Service (`check_service`)
1. **Connection Test**: Verifies anonymous login works
2. **Directory Listing**: Tests LIST command functionality
3. **File Operations**: Tests complete upload/download cycle
4. **Directory Creation**: Tests MKDIR command
5. **Consistency Check**: Verifies files appear in listings

### Check Flag (`check_flag`)
1. **Flag ID Parsing**: Retrieves stored flag location from JSON
2. **File Retrieval**: Downloads flag file using stored filename
3. **Content Verification**: Compares retrieved content with expected flag
4. **Error Handling**: Returns appropriate result codes for different failure modes

## Result Codes

The checker returns standard FAUST CTF result codes:

- `CheckResult.OK` - Service is working correctly
- `CheckResult.DOWN` - Service is not reachable/responding
- `CheckResult.FAULTY` - Service is reachable but not working correctly
- `CheckResult.FLAG_NOT_FOUND` - Flag could not be retrieved

## Error Handling

The checker includes comprehensive error handling:

- **Network Timeouts**: 10-second timeout for all operations
- **Protocol Errors**: Validates magic numbers and packet structure
- **Authentication Failures**: Handles login errors gracefully
- **File System Errors**: Manages missing files and permissions
- **Connection Cleanup**: Ensures connections are properly closed

## Testing

### Local Testing
```bash
# Test against local server
./checker.py 127.0.0.1 10 1

# Expected output:
# Running checker for team 1 on 127.0.0.1, tick 10
# Place flag result: OK
# Service check result: OK
# Flag check result: OK
```

### Integration Testing
```bash
# Test with real gameserver
python3 -m ctf_gameserver.checker.master --config config.yml --service ftp --team 1 --tick 5
```

## Configuration Options

### Timeouts
The checker uses a 10-second timeout for network operations. Adjust in `FTPClient.__init__()`:

```python
def __init__(self, host: str, port: int = 2121, timeout: int = 10):
```

### Port Configuration
Default port is 2121. Change in `FTPChecker` class:

```python
class FTPChecker(checkerlib.BaseChecker):
    PORT = 2121  # Change this value
```

### Random String Generation
Adjust filename randomness in `_generate_random_string()`:

```python
def _generate_random_string(self, length: int = 10) -> str:
    return ''.join(random.choices(string.ascii_letters + string.digits, k=length))
```

## Monitoring and Debugging

### Enable Debug Output
For additional logging, modify the checker to include debug prints:

```python
import logging
logging.basicConfig(level=logging.DEBUG)
```

### State Persistence
The checker stores state in JSON format. Monitor state files:

```bash
# Check stored state
cat _state.json | jq .

# Example state structure:
{
  "user_creds_10": {
    "username": "user_1_10_abc123",
    "password": "randompass123"
  },
  "flagid_10": "{\"filename\": \"flag_10_xyz789.txt\", ...}"
}
```

### Common Issues

1. **Service Down**: Check if FTP server is running on correct port
2. **Flag Not Found**: Verify flag file wasn't deleted by other teams
3. **Authentication Errors**: Ensure anonymous access is enabled
4. **Network Issues**: Check firewall rules and connectivity

## Security Considerations

### Checker Security
- Uses anonymous access to avoid credential management
- Generates random filenames to avoid collisions
- Includes timeout protection against hanging connections
- Validates all network input before processing

### Service Security
The checker exercises normal functionality and doesn't:
- Attempt to exploit vulnerabilities
- Perform privilege escalation
- Access files outside the FTP root
- Interfere with other teams' operations

## Performance Optimization

### Connection Reuse
Consider implementing connection pooling for high-frequency checks:

```python
# Keep connection alive across operations
def _get_connection(self):
    if not self.client or not self.client.authenticated:
        self._connect_and_auth(anonymous=True)
    return self.client
```

### Batch Operations
Group multiple file operations to reduce network overhead:

```python
# Upload multiple files in single session
def place_multiple_flags(self, flags):
    if not self._connect_and_auth(anonymous=True):
        return False
    
    for flag in flags:
        self.client.put_file(f"flag_{flag['tick']}.txt", flag['data'])
    
    self._disconnect()
```

## Deployment Checklist

- [ ] CTF gameserver installed and configured
- [ ] Checker script copied to correct location
- [ ] Execute permissions set on checker script
- [ ] Network connectivity to FTP service verified
- [ ] Service configuration added to gameserver config
- [ ] Local testing completed successfully
- [ ] Integration testing with gameserver completed
- [ ] Monitoring and logging configured
- [ ] Error handling verified with edge cases

## Support

For issues with the checker:

1. Check gameserver logs for error messages
2. Test connectivity to FTP service manually
3. Verify service is responding to anonymous login
4. Check state file for corrupted data
5. Test with local FTP server instance

The checker is designed to be robust and handle various failure scenarios gracefully while providing useful feedback for debugging.
