FROM ubuntu:22.04

# Prevent interactive prompts during package installation
ENV DEBIAN_FRONTEND=noninteractive

# Enable 32-bit architecture
RUN dpkg --add-architecture i386

# Update package list and install essential tools
RUN apt-get update && apt-get install -y \
    build-essential \
    git \
    wget \
    curl \
    python3 \
    python3-pip \
    python3-dev \
    gdb \
    gdb-multiarch \
    libc6-dbg \
    libc6-dbg:i386 \
    gcc-multilib \
    g++-multilib \
    nasm \
    vim \
    tmux \
    file \
    strace \
    ltrace \
    xxd \
    binutils \
    bsdmainutils \
    socat \
    netcat-openbsd \
    ssh \
    sudo \
    man-db \
    && rm -rf /var/lib/apt/lists/*

# Install Neovim
RUN wget -O /tmp/nvim.appimage https://github.com/neovim/neovim/releases/download/nightly/nvim-linux-x86_64.appimage && \
    chmod +x /tmp/nvim.appimage && \
    /tmp/nvim.appimage --appimage-extract && \
    mv squashfs-root /opt/nvim && \
    ln -s /opt/nvim/AppRun /usr/local/bin/nvim && \
    rm /tmp/nvim.appimage

# Install pwntools
RUN pip3 install --upgrade pip && \
    pip3 install pwntools

# Install pwndbg
RUN git clone https://github.com/pwndbg/pwndbg.git /opt/pwndbg && \
    cd /opt/pwndbg && \
    ./setup.sh

# Install GEF (alternative to pwndbg)
RUN wget -O ~/.gdbinit-gef.py https://gef.blah.cat/py && \
    echo "source ~/.gdbinit-gef.py" >> ~/.gdbinit-gef

# Install ropper (ROP gadget finder)
RUN pip3 install ropper

# Install one_gadget
RUN apt-get update && apt-get install -y ruby ruby-dev && \
    gem install one_gadget && \
    rm -rf /var/lib/apt/lists/*


# Install pwninit
RUN wget -O /tmp/pwninit https://github.com/io12/pwninit/releases/latest/download/pwninit && \
    chmod +x /tmp/pwninit && \
    mv /tmp/pwninit /usr/local/bin/

# Create a non-root user for safer operation
RUN useradd -m -s /bin/bash pwner && \
    echo "pwner ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers

# Set up workspace
USER pwner
WORKDIR /home/pwner

# Copy pwndbg config to user home
RUN cat << EOF >> /home/pwner/.gdbinit
source /opt/pwndbg/gdbinit.py
set emulate off
set telescope-skip-repeating-val off
set show-tips off

# source /home/x3ero0/.pyenv/versions/3.10.17/lib/python3.10/site-packages/decomp2dbg/d2d.py
set debuginfod enabled on
EOF

# Create workspace directories
RUN mkdir -p /home/pwner/workspace /home/pwner/tools /home/pwner/exploits

# Set up a basic .vimrc for convenience
RUN echo "set number\nset tabstop=4\nset shiftwidth=4\nset expandtab\nsyntax on" > /home/pwner/.vimrc

# Set up basic neovim config
RUN mkdir -p /home/pwner/.config/nvim && \
    echo "set number\nset tabstop=4\nset shiftwidth=4\nset expandtab\nsyntax on" > /home/pwner/.config/nvim/init.vim

# Add useful aliases
RUN echo "alias ll='ls -la'" >> /home/pwner/.bashrc && \
    echo "alias gdb='gdb -q'" >> /home/pwner/.bashrc && \
    echo "alias py='python3'" >> /home/pwner/.bashrc

# Set environment variables
ENV TERM=xterm-256color
ENV EDITOR=nvim

WORKDIR /home/pwner/workspace

CMD ["/bin/bash"]
