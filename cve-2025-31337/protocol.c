#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include <sys/socket.h>
#include <netinet/in.h>
#include <arpa/inet.h>
#include "ftp_server.h"

int send_packet(int socket_fd, uint8_t type, const void *data, uint16_t length) {
    packet_header_t header;
    header.magic = htonl(FTP_MAGIC);
    header.type = type;
    header.length = htons(length);
    
    // Send header
    ssize_t sent = send(socket_fd, &header, sizeof(header), MSG_NOSIGNAL);
    if (sent != sizeof(header)) {
        return -1;
    }
    
    // Send data if present
    if (length > 0 && data != NULL) {
        sent = send(socket_fd, data, length, MSG_NOSIGNAL);
        if (sent != length) {
            return -1;
        }
    }
    
    return length + sizeof(header);
}

int recv_packet(int socket_fd, packet_header_t *header, void *buffer, size_t buffer_size) {
    // Receive header
    ssize_t received = recv(socket_fd, header, sizeof(packet_header_t), MSG_WAITALL);
    if (received != sizeof(packet_header_t)) {
        return -1;
    }
    
    // Convert from network byte order
    header->magic = ntohl(header->magic);
    header->length = ntohs(header->length);
    
    // Validate magic number
    if (header->magic != FTP_MAGIC) {
        return -1;
    }
    
    // Validate packet length
    if (header->length > MAX_PACKET_SIZE || header->length > buffer_size) {
        return -1;
    }
    
    // Receive payload if present
    if (header->length > 0) {
        received = recv(socket_fd, buffer, header->length, MSG_WAITALL);
        if (received != header->length) {
            return -1;
        }
    }
    
    return header->length;
}

void send_error_response(int socket_fd, const char *message) {
    uint8_t status = STATUS_ERROR;
    uint16_t msg_len = strlen(message);
    
    // Create response packet
    size_t response_size = 1 + 2 + msg_len;  // status + length + message
    char *response = malloc(response_size);
    
    response[0] = status;
    *(uint16_t*)(response + 1) = htons(msg_len);
    memcpy(response + 3, message, msg_len);
    
    send_packet(socket_fd, RESP_GENERIC, response, response_size);
    free(response);
}

void send_success_response(int socket_fd, const char *message) {
    uint8_t status = STATUS_SUCCESS;
    uint16_t msg_len = strlen(message);
    
    // Create response packet
    size_t response_size = 1 + 2 + msg_len;  // status + length + message
    char *response = malloc(response_size);
    
    response[0] = status;
    *(uint16_t*)(response + 1) = htons(msg_len);
    memcpy(response + 3, message, msg_len);
    
    send_packet(socket_fd, RESP_GENERIC, response, response_size);
    free(response);
}

int authenticate_user(const char *username, const char *password, user_t *user) {
    return verify_user(username, password, user);
}

int authenticate_anonymous(user_t *user) {
    // Setup anonymous user
    user->id = -1;
    strcpy(user->username, "anonymous");
    strcpy(user->password_hash, "");
    strcpy(user->salt, "");
    strcpy(user->home_directory, "anonymous");
    return 0;
}
