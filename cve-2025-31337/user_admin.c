#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include "ftp_server.h"

void print_usage(const char *program_name) {
    printf("Usage: %s <command> [arguments]\n", program_name);
    printf("Commands:\n");
    printf("  create_user <username> <password> <home_directory>\n");
    printf("  list_users\n");
    printf("  delete_user <username>\n");
    printf("  init_db <database_path>\n");
    printf("\nExamples:\n");
    printf("  %s create_user alice secret123 user_alice\n", program_name);
    printf("  %s list_users\n", program_name);
    printf("  %s delete_user alice\n", program_name);
}

int cmd_create_user(int argc, char *argv[]) {
    if (argc != 5) {
        printf("Usage: create_user <username> <password> <home_directory>\n");
        return 1;
    }
    
    const char *username = argv[2];
    const char *password = argv[3];
    const char *home_dir = argv[4];
    
    // Initialize database (creates if doesn't exist)
    if (init_database("ftp_users.db") != 0) {
        fprintf(stderr, "Failed to initialize database\n");
        return 1;
    }
    
    // Create user
    if (create_user(username, password, home_dir) != 0) {
        fprintf(stderr, "Failed to create user\n");
        return 1;
    }
    
    printf("User '%s' created successfully with home directory '%s'\n", username, home_dir);
    return 0;
}

int cmd_list_users() {
    // Initialize database
    if (init_database("ftp_users.db") != 0) {
        fprintf(stderr, "Failed to initialize database\n");
        return 1;
    }
    
    // This is a simplified version - in a real implementation,
    // you'd add a proper list_users function to database.c
    printf("List users functionality not fully implemented yet.\n");
    printf("Use sqlite3 ftp_users.db \"SELECT * FROM users;\" to list users manually.\n");
    return 0;
}

int cmd_delete_user(int argc, char *argv[]) {
    if (argc != 3) {
        printf("Usage: delete_user <username>\n");
        return 1;
    }
    
    const char *username = argv[2];
    
    // Initialize database
    if (init_database("ftp_users.db") != 0) {
        fprintf(stderr, "Failed to initialize database\n");
        return 1;
    }
    
    // This is a simplified version - in a real implementation,
    // you'd add a proper delete_user function to database.c
    printf("Delete user functionality not fully implemented yet.\n");
    printf("Use sqlite3 ftp_users.db \"DELETE FROM users WHERE username='%s';\" manually.\n", username);
    return 0;
}

int cmd_init_db(int argc, char *argv[]) {
    if (argc != 3) {
        printf("Usage: init_db <database_path>\n");
        return 1;
    }
    
    const char *db_path = argv[2];
    
    if (init_database(db_path) != 0) {
        fprintf(stderr, "Failed to initialize database\n");
        return 1;
    }
    
    printf("Database '%s' initialized successfully\n", db_path);
    return 0;
}

int main(int argc, char *argv[]) {
    if (argc < 2) {
        print_usage(argv[0]);
        return 1;
    }
    
    const char *command = argv[1];
    
    if (strcmp(command, "create_user") == 0) {
        return cmd_create_user(argc, argv);
    } else if (strcmp(command, "list_users") == 0) {
        return cmd_list_users();
    } else if (strcmp(command, "delete_user") == 0) {
        return cmd_delete_user(argc, argv);
    } else if (strcmp(command, "init_db") == 0) {
        return cmd_init_db(argc, argv);
    } else {
        printf("Unknown command: %s\n", command);
        print_usage(argv[0]);
        return 1;
    }
}
